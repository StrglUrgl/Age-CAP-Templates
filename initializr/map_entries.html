<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

 <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

<!-- ==========================================================================
   Navbar Code
   ========================================================================== -->

        <div class="navbar navbar-fixed-top">
          <div class="navbar-inner">

            <div class="container-fluid" id="header-container">
            
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="back-btn"> <button class="btn btn-info" onClick="history.go(-1);return true;">BACK</button> </div>
              <a id="page-title" class="brand">View Results</a>

              <div class="nav-collapse collapse">
                <ul class="nav">
                  <li><a href="index.html">Home <span class="icon-home"></span></a></li>
                  <li> <a id="font-button">Change Font Size  <span class="icon-font"></span></a></li>
                  <li> <a href="#myModal" data-toggle="modal">About Age-CAP</a></li>
                </ul>
              </div><!--/.nav-collapse -->

            </div>
          </div>
        </div>

<!-- ==========================================================================
   End Navbar Code
   ========================================================================== -->
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span8 offset2 question_background">
                  <h4 id="headline" style="text-decoration:underline">Viewing Locations</h4>
                    <h5>
                    View prior ratings below, or go back to adjust your search settings.
                    </h5>
                    <a href="results-list-from-template.html"class="btn btn-info">Alter Search Settings</a> 
                    <a href="select_landing_read.html"class="btn btn-info">Choose a New Starting Point</a> 
                </div>
            </div>
            <div class="spacer10"></div>
            <div class="row-fluid">
                <div class="span8 offset2 question_background">
                <div id="map"></div>  
                </div>
            </div>
        </div>

<!-- ==========================================================================
  Modal Code
   ========================================================================== -->

        <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">  
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="myModalLabel">About Age-CAP</h3>
          </div>
          <div class="modal-body">
            <p style=\'text-align:justify\'>Age-CAP is a smartphone application which aims to create a crowd-sourced database of age-friendly locations. It consists of survey styled forms which enable users to quickly rate a location. Users are also able to browse this database to assess the age-friendliness of locations in their neighborhood, providing them access to information which was otherwise unavailable. <br><br>Age-CAP was created by a multi-disciplinary team from the Toronto Rehabilitation Institute, University Health Network and University of Toronto.<br><br>Feedback or questions: iatsl@utoronto.ca</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-info" data-dismiss="modal" aria-hidden="true">Close</button>
          </div>
        </div>
<!-- ==========================================================================
   End Modal Code
   ========================================================================== -->

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script> <!--- failsafe to load up jQuery if the online copy is unavailable-->
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="js/bounding.js"></script>

<script>

var resultsArray= new Array();
var marker = new Array();
var infowindow = new Array();
var i;

  function getEntries(){
    coords = JSON.parse(localStorage.getItem("starting_coords")); 
    radius = Number(localStorage.getItem("radius"));
    table = localStorage.getItem("tableToView");
    names = JSON.parse(localStorage.getItem("names"));
    name = names[table]

    $("#headline").html("Viewing "+name+" Locations within "+radius+" kilometers");

    if (radius == "all")
    {
      dataArray={table:table, infiniteRadius:1};
    }
    else
    {
      var boundingArray = boundingCoordinates(radius, 6371, coords["lat"], coords["lng"]);
      var dataArray = {table:table, minLat:boundingArray["minLat"], maxLat:boundingArray["maxLat"], minLng:boundingArray["minLon"], maxLng:boundingArray["maxLon"]}
    }
    

$.ajax({type:'POST', 
  url:'http://142.150.169.179/map_entries.php', 
  dataType: 'json', 
  data:dataArray, 
  success: function(data){populateMap(data);}, 
  error:function(data){resultsArray = data; $('#map').html(data.responseText);}});

    function populateMap(data){
    resultsArray  = data; 
    //alert("(0,0) " + resultsArray[0][0] + " (1,0) " + resultsArray[1][0] + " (2,0) " + resultsArray[2][0] +" Rows -Boss " + resultsArray.length + " Columns-Boss[0]" + resultsArray[0].length);
    if(resultsArray[0].length== 0){$('#map').html("<br><br><p align=\'center\'>No results found for your search. Try another search term or broaden you search by entering city name. </p>");}
    else{
    var latlng = new google.maps.LatLng(coords["lat"], coords["lng"]);
    var mapOptions = {
        zoom: 11,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        zoomControl: true,
        mapTypeControl: false,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL
        } 
    };

    var manasmap = new google.maps.Map(document.getElementById("map"), mapOptions);
  
    for (i=0;i<resultsArray[0].length;i++){
      var currentLatitude = resultsArray[1][i];
      var currentLongitude =resultsArray[2][i];
      
      var latlng_m = new google.maps.LatLng(currentLatitude, currentLongitude);
      
      marker[i] = new google.maps.Marker({
          position: latlng_m,
          map: manasmap,
          title: resultsArray[0][i]
        });


  function listenMarker (mark, i)
    {
      
      google.maps.event.addListener(mark, 'click', function(e) {
        $("#LocName").val(resultsArray[0][i]);
        localStorage.setItem("nameToView", resultsArray[0][i]);
        localStorage.setItem("postalCodeToView", resultsArray[4][i]);
        localStorage.setItem("typeToView", resultsArray[5][i]);

         if (mark.infowindow) {
         mark.infowindow.close();
        }// This is incase of multiple clicks on the marker, several infowindows are not opened. Not really required, but still.
        mark.infowindow = new google.maps.InfoWindow();
        mark.infowindow.setContent( resultsArray[0][i] + ' <br>Average rating: ' + resultsArray[3][i] +  '<br><a href="view-rating-from-template.html" style="float:right">View rating>></a>'); 
        mark.infowindow.open(manasmap,mark);
        setTimeout(function () { mark.infowindow.close(); }, 3000); //This was a good idea to substitute instead of the close others when new opens attempt. 

      });
      
    } 
        
    mark = marker[i];
    listenMarker(mark,i); 
    }    
    }//else finish
    }//This is the end of populateMap func.
return resultsArray;
}


getEntries(); 

</script>



    <!--script>
    var mapOptions = {
    center: new google.maps.LatLng(43.707842,-79.393473),
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById('map'), mapOptions);

    var markerOptions = {
        position: new google.maps.LatLng(43.707842,-79.393473),
        map: map
    };
    var marker = new google.maps.Marker(markerOptions);
    marker.setMap(map);

    var infoWindowOptions = {
        content: '<div id="content"> <h4>Central Eglinton Community Centre</h4> This location has 1 rating(s).<br> Average score is <strong>3.5</strong></div>' +
        '<div class="spacer10"></div><a href="view_ratings.html" class="btn btn-info">View Ratings</a>'
    };

    var infoWindow = new google.maps.InfoWindow(infoWindowOptions);
    google.maps.event.addListener(marker,'click',function(e){
      
      infoWindow.open(map, marker);
      
    });
    </script-->

    </body>
</html>